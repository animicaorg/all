# Animica Devnet (dev profile)
# -------------------------------------------------------------------
# Spin up:
#   - 2 nodes (RPC+WS on 8545/9545) using the repo source (mounted)
#   - 1 CPU miner pointed at node1
#   - studio-services API (deploy / verify / faucet) on 8787
#   - explorer-web (static preview) on 5173
#
# Usage:
#   docker compose -f tests/devnet/docker-compose.yml --profile dev up --build
#   docker compose -f tests/devnet/docker-compose.yml --profile dev down -v
#
# Notes:
# - This is a developer-friendly stack. Python deps are baked into the
#   node/miner images; your local repo is mounted read-only for code access.
#   explorer still installs Node deps at container start.
# - SQLite is used for persistence; volumes keep data across restarts.
# - If your modules expose different CLIs, adjust commands/env below.
# -------------------------------------------------------------------
name: animica-devnet

networks:
  devnet:
    driver: bridge

volumes:
  node1_data:
  node2_data:
  services_data:

services:
  # ---------------------------------------------------------------
  # Node 1: core + rpc (+ ws) using your local source tree
  # ---------------------------------------------------------------
  node1:
    profiles: [dev]
    build:
      context: ../..
      dockerfile: ops/docker/node.Dockerfile
    container_name: animica-node1
    user: "root"
    working_dir: /app
    env_file:
      - ./env.devnet.example
    volumes:
      - ../..:/app:ro
      - node1_data:/data
    environment:
      # DB & chain config (matches rpc.config expectations)
      ANIMICA_CHAIN_ID: "${ANIMICA_CHAIN_ID:-1337}"
      ANIMICA_RPC_DB_URI: "${ANIMICA_RPC_DB_URI:-sqlite:////data/animica.db}"
      GENESIS_PATH: "${GENESIS_PATH:-core/genesis/genesis.json}"
      # RPC server config (FastAPI)
      ANIMICA_RPC_HOST: "${ANIMICA_RPC_HOST:-0.0.0.0}"
      ANIMICA_RPC_PORT: "${ANIMICA_RPC_PORT:-8545}"
      ANIMICA_RPC_CORS_ORIGINS: "${ANIMICA_RPC_CORS_ORIGINS:-[*]}"
      ANIMICA_LOG_LEVEL: "${ANIMICA_LOG_LEVEL:-INFO}"
    command: ["/bin/bash", "/app/tests/devnet/node-entry.sh", "node1"]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8545/healthz || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20
    ports:
      - "${HOST_NODE1_RPC:-8545}:8545"
    networks: [devnet]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ---------------------------------------------------------------
  # Node 2: optional peer node (separate DB, different RPC port)
  # ---------------------------------------------------------------
  node2:
    profiles: [dev]
    build:
      context: ../..
      dockerfile: ops/docker/node.Dockerfile
    container_name: animica-node2
    user: "root"
    working_dir: /app
    env_file:
      - ./env.devnet.example
    volumes:
      - ../..:/app:ro
      - node2_data:/data
    environment:
      ANIMICA_CHAIN_ID: "${ANIMICA_CHAIN_ID:-1337}"
      ANIMICA_RPC_DB_URI: "${ANIMICA_NODE2_RPC_DB_URI:-sqlite:////data/animica.db}"
      GENESIS_PATH: "${GENESIS_PATH:-core/genesis/genesis.json}"
      ANIMICA_RPC_HOST: "${ANIMICA_RPC_HOST:-0.0.0.0}"
      ANIMICA_RPC_PORT: "${ANIMICA_NODE2_RPC_PORT:-9545}"
      ANIMICA_RPC_CORS_ORIGINS: "${ANIMICA_RPC_CORS_ORIGINS:-[*]}"
      ANIMICA_LOG_LEVEL: "${ANIMICA_LOG_LEVEL:-INFO}"
    command: ["/bin/bash", "/app/tests/devnet/node-entry.sh", "node2"]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9545/readyz || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20
    ports:
      - "${HOST_NODE2_RPC:-9545}:9545"
    networks: [devnet]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      node1:
        condition: service_healthy

  # ---------------------------------------------------------------
  # CPU Miner targeting node1 (HashShare + useful-proof workers optional)
  # ---------------------------------------------------------------
  miner:
    profiles: [dev]
    build:
      context: ../..
      dockerfile: ops/docker/miner.Dockerfile
    container_name: animica-miner
    working_dir: /app
    volumes:
      - ../..:/app:ro
    environment:
      RPC_URL: "${DEVNET_RPC_URL:-http://node1:8545}"
      DEVICE: "${MINER_DEVICE:-cpu}"
      THREADS: "${MINER_THREADS:-2}"
      LOG_LEVEL: "${MINER_LOG_LEVEL:-INFO}"
    command: >
      bash -lc "
      set -euo pipefail;
      exec python -m mining.cli.miner --threads $${THREADS} --device $${DEVICE} --rpc $${RPC_URL}
      "
    depends_on:
      node1:
        condition: service_healthy
    networks: [devnet]

  # ---------------------------------------------------------------
  # studio-services (deploy / verify / faucet / artifacts)
  # ---------------------------------------------------------------
  services:
    profiles: [dev]
    build:
      context: ../../studio-services
      dockerfile: Dockerfile
    container_name: animica-studio-services
    environment:
      RPC_URL: "${DEVNET_RPC_URL:-http://node1:8545}"
      CHAIN_ID: "${ANIMICA_CHAIN_ID:-1337}"
      STORAGE_DIR: "/var/lib/services/storage"
      RATE_LIMITS: "burst=20,per_min=120"
      LOG_LEVEL: "${STUDIO_LOG_LEVEL:-INFO}"
      FAUCET_KEY: "${FAUCET_KEY:-}"
    volumes:
      - services_data:/var/lib/services
    ports:
      - "${HOST_STUDIO_SERVICES:-8787}:8787"
    command: >
      bash -lc "
      set -euo pipefail;
      # If image already contains deps, this is a no-op
      python -m studio_services.main --host 0.0.0.0 --port 8787
      "
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8787/healthz || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20
    depends_on:
      node1:
        condition: service_healthy
    networks: [devnet]

  # ---------------------------------------------------------------
  # explorer-web (build once, serve with vite preview)
  # ---------------------------------------------------------------
  explorer:
    profiles: [dev]
    image: node:20-alpine
    container_name: animica-explorer
    working_dir: /app
    environment:
      VITE_RPC_URL: "http://localhost:${HOST_NODE1_RPC:-8545}"       # browser hits your host â†’ forwarded to node1
      VITE_CHAIN_ID: "${ANIMICA_CHAIN_ID:-1337}"
      # Optional studio-services integration
      VITE_SERVICES_URL: "http://localhost:${HOST_STUDIO_SERVICES:-8787}"
    volumes:
      - ../../explorer-web:/app:rw
    ports:
      - "${HOST_EXPLORER:-5173}:5173"
    command: >
      sh -lc "
      set -eu;
      corepack enable || true;
      if ! command -v pnpm >/dev/null 2>&1; then npm i -g pnpm@9; fi;
      pnpm install --frozen-lockfile || pnpm install;
      pnpm run build;
      pnpm exec vite preview --host 0.0.0.0 --port 5173
      "
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:5173/ >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
    depends_on:
      node1:
        condition: service_healthy
      services:
        condition: service_healthy
    networks: [devnet]
