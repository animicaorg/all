# Netlify configuration for Animica Website (Astro static export)
# Docs: https://docs.netlify.com/configure-builds/file-based-configuration/

[build]
  command = "pnpm build"
  publish = "out"

[build.environment]
  NODE_VERSION = "20"
  PNPM_VERSION = "9"

#######################################################################
# Global Security & Caching Headers
#######################################################################

# Default: HTML & route pages (short cache, always revalidate)
[[headers]]
  for = "/*"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options = "nosniff"
    X-Frame-Options = "DENY"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "browsing-topics=()"
    # NOTE: Tailwind inlines small <style> blocks at build; keep 'unsafe-inline' for styles only.
    Content-Security-Policy = """
      default-src 'self';
      base-uri 'self';
      form-action 'self';
      frame-ancestors 'none';
      object-src 'none';
      font-src 'self' data:;
      img-src 'self' data: blob:;
      script-src 'self';
      style-src 'self' 'unsafe-inline';
      connect-src 'self' https://rpc.animica.org https://studio.animica.org https://explorer.animica.org;
      upgrade-insecure-requests;
    """

# Hashed static assets generated by Astro live under /_astro — cache hard
[[headers]]
  for = "/_astro/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# First-party images (adjust path if you use /public/images)
[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

#######################################################################
# Redirects
#######################################################################

# Canonical domain: redirect www → apex (adjust to your preference)
# This uses host-based conditions so it only runs when the request host matches.
[[redirects]]
  from = "https://www.animica.org/*"
  to = "https://animica.org/:splat"
  status = 301
  force = true
  conditions = { Host = ["www.animica.org"] }

# If you host previews under a different domain, you can add additional host rules above.

# Example legacy docs route (uncomment/adjust if needed)
# [[redirects]]
#   from = "/docs/*"
#   to = "https://docs.animica.org/:splat"
#   status = 302

#######################################################################
# Edge Functions (optional)
#######################################################################
# Map URL paths to Netlify Edge Functions if/when you add them.
# Place your function source in /netlify/edge-functions/{name}.ts
# Docs: https://docs.netlify.com/edge-functions/overview/

# Example: lightweight proxy for public APIs (CORS headers, etc.)
# [[edge_functions]]
#   path = "/api/*"
#   function = "proxy"

# Example: dynamic security headers (if you prefer at the edge instead of static headers)
# [[edge_functions]]
#   path = "/*"
#   function = "securityHeaders"

#######################################################################
# Plugins (optional)
#######################################################################
# [plugins]
#   # Example: Include official Next/Astro plugins if you switch to SSR.
#   # packages = ["@netlify/astro-adapter"]  # not required for static export

