{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://animica.org/schemas/variables.schema.json",
  "title": "Animica Template Variables Definition",
  "description": "Schema describing the **variables specification** for a contract template. Tooling (scaffolders/CLIs/IDEs) reads a file that conforms to this schema to dynamically render prompts, validate user input, and produce a concrete values file used to instantiate the template.",
  "type": "object",
  "additionalProperties": false,

  "properties": {
    "schema_version": {
      "type": "integer",
      "minimum": 1,
      "description": "Monotonic integer for the variables schema itself. Increment on breaking changes."
    },
    "template_id": {
      "$ref": "#/$defs/Id",
      "description": "ID of the template this variables spec belongs to (must match templates/index.json)."
    },
    "version": {
      "$ref": "#/$defs/SemVer",
      "description": "Version of this variables spec for the given template (does not imply template package version)."
    },
    "title": {
      "type": "string",
      "minLength": 2,
      "maxLength": 80,
      "description": "Human-readable title shown by UIs."
    },
    "description": {
      "type": "string",
      "minLength": 10,
      "maxLength": 1200,
      "description": "Longer description with guidance and gotchas for integrators."
    },
    "groups": {
      "type": "array",
      "description": "Optional logical sections to organize variables in a UI.",
      "items": { "$ref": "#/$defs/Group" },
      "uniqueItems": true,
      "minItems": 0
    },
    "vars": {
      "type": "array",
      "description": "Ordered list of variables the template accepts. Tools render these as prompts, apply validation, and materialize a values object.",
      "items": { "$ref": "#/$defs/VarDef" },
      "minItems": 1,
      "uniqueItems": true
    }
  },

  "required": ["schema_version", "template_id", "vars"],

  "$defs": {
    "SemVer": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+(?:[-+][0-9A-Za-z.-]+)?$",
      "examples": ["0.1.0", "1.0.0-rc.1"]
    },
    "Id": {
      "type": "string",
      "pattern": "^[a-z0-9][a-z0-9_-]{1,48}$",
      "examples": ["counter", "ai-agent", "quantum-rng"]
    },
    "Group": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "id": { "$ref": "#/$defs/Id" },
        "title": {
          "type": "string",
          "minLength": 2,
          "maxLength": 80
        },
        "description": {
          "type": "string",
          "minLength": 0,
          "maxLength": 600
        },
        "order": {
          "type": "number",
          "description": "Ascending sort key; lower appears first."
        }
      },
      "required": ["id", "title"]
    },

    "VarType": {
      "type": "string",
      "enum": [
        "string",          // single-line string
        "text",            // multi-line text
        "integer",         // 64-bit safe integer (tools may use BigInt)
        "number",          // floating number
        "boolean",         // true/false
        "address",         // anim1… (bech32m) or 0x… (20-byte)
        "bech32_address",  // explicit bech32m (anim1…)
        "hex_address",     // explicit 0x-hex 20 bytes
        "chain_id",        // positive integer chain id
        "url",             // http/https URL
        "path",            // relative POSIX path
        "enum",            // one-of choices (string)
        "list_string",     // array of strings
        "list_address"     // array of addresses
      ]
    },

    "UIHints": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "group": { "$ref": "#/$defs/Id" },
        "order": { "type": "number", "description": "Ascending sort key within group." },
        "widget": {
          "type": "string",
          "enum": ["input", "textarea", "select", "checkbox", "switch", "tags"],
          "description": "UI widget hint; tools may ignore."
        },
        "placeholder": { "type": "string" },
        "hint": { "type": "string" },
        "mask_secret": {
          "type": "boolean",
          "default": false,
          "description": "If true, UIs should avoid echoing the value (e.g., API keys)."
        }
      }
    },

    "When": {
      "type": "object",
      "description": "Simple conditional to show/require a var based on another variable's value.",
      "additionalProperties": false,
      "properties": {
        "var": { "$ref": "#/$defs/Id" },
        "equals": { "type": ["string", "number", "boolean", "null"] },
        "in": {
          "type": "array",
          "items": { "type": ["string", "number", "boolean", "null"] },
          "minItems": 1,
          "uniqueItems": true
        }
      },
      "oneOf": [
        { "required": ["var", "equals"] },
        { "required": ["var", "in"] }
      ]
    },

    "Compute": {
      "type": "object",
      "description": "Optional computed default. 'template' is a Mustache-like string; tools may support a small expression language.",
      "additionalProperties": false,
      "properties": {
        "template": { "type": "string" },
        "depends_on": {
          "type": "array",
          "items": { "$ref": "#/$defs/Id" },
          "uniqueItems": true
        }
      },
      "required": ["template"]
    },

    "NumericBounds": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "minimum": { "type": "number" },
        "exclusiveMinimum": { "type": "number" },
        "maximum": { "type": "number" },
        "exclusiveMaximum": { "type": "number" },
        "multipleOf": { "type": "number", "exclusiveMinimum": 0 }
      }
    },

    "StringBounds": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "minLength": { "type": "integer", "minimum": 0 },
        "maxLength": { "type": "integer", "minimum": 1 },
        "pattern": { "type": "string" }
      }
    },

    "EnumSpec": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "choices": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1,
          "uniqueItems": true
        },
        "labels": {
          "type": "object",
          "description": "Optional map choice->label for UI.",
          "additionalProperties": { "type": "string" }
        }
      },
      "required": ["choices"]
    },

    "VarDef": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "id": { "$ref": "#/$defs/Id" },
        "type": { "$ref": "#/$defs/VarType" },
        "title": {
          "type": "string",
          "minLength": 2,
          "maxLength": 80
        },
        "description": {
          "type": "string",
          "minLength": 0,
          "maxLength": 800
        },
        "required": {
          "type": "boolean",
          "default": true
        },
        "default": {},
        "examples": {
          "type": "array",
          "items": {},
          "uniqueItems": true
        },
        "ui": { "$ref": "#/$defs/UIHints" },
        "when": { "$ref": "#/$defs/When" },
        "compute": { "$ref": "#/$defs/Compute" },

        /* Common validation facets (subset of JSON Schema for convenience) */
        "numeric": { "$ref": "#/$defs/NumericBounds" },
        "string":  { "$ref": "#/$defs/StringBounds" },
        "enum":    { "$ref": "#/$defs/EnumSpec" },

        /* Address & network-specific toggles */
        "address_network": {
          "type": "string",
          "enum": ["animica"],
          "description": "Set to 'animica' to prefer/require 'anim1…' bech32m addresses."
        }
      },
      "required": ["id", "type", "title"],

      "allOf": [
        {
          "if": { "properties": { "type": { "const": "enum" } }, "required": ["type"] },
          "then": { "required": ["enum"] }
        },
        {
          "if": { "properties": { "type": { "const": "integer" } }, "required": ["type"] },
          "then": {
            "properties": {
              "default": { "type": ["integer", "null"] }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "number" } }, "required": ["type"] },
          "then": {
            "properties": {
              "default": { "type": ["number", "integer", "null"] }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "boolean" } }, "required": ["type"] },
          "then": {
            "properties": {
              "default": { "type": ["boolean", "null"] }
            }
          }
        },
        {
          "if": { "properties": { "type": { "enum": ["string", "text"] } }, "required": ["type"] },
          "then": {
            "properties": {
              "default": { "type": ["string", "null"] }
            }
          }
        }
      ]
    },

    /* Validators that scaffolding tools may use when assembling the final values. */
    "Validators": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "patterns": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "bech32_anim": {
              "type": "string",
              "const": "^(anim1)[023456789acdefghjklmnpqrstuvwxyz]{20,87}$"
            },
            "hex_bytes": {
              "type": "string",
              "const": "^0x[0-9a-fA-F]+$"
            },
            "hex_addr20": {
              "type": "string",
              "const": "^0x[0-9a-fA-F]{40}$"
            },
            "symbol": {
              "type": "string",
              "const": "^[A-Z]{2,11}$"
            },
            "project": {
              "type": "string",
              "const": "^[A-Za-z][A-Za-z0-9 _-]{2,32}$"
            }
          }
        }
      }
    }
  },

  "examples": [
    {
      "schema_version": 1,
      "template_id": "token",
      "version": "0.2.0",
      "title": "Fungible Token (Animica-20) — Variables",
      "description": "Customize token metadata and initial distribution. Owner can be a regular address or a multisig.",
      "groups": [
        { "id": "meta", "title": "Metadata", "order": 1 },
        { "id": "dist", "title": "Distribution", "order": 2 },
        { "id": "chain", "title": "Network", "order": 3 }
      ],
      "vars": [
        {
          "id": "project_name",
          "type": "string",
          "title": "Project name",
          "description": "Used in artifact names and package labels.",
          "string": { "pattern": "^[A-Za-z][A-Za-z0-9 _-]{2,32}$" },
          "default": "my-token",
          "ui": { "group": "meta", "order": 1, "widget": "input", "placeholder": "my-token" }
        },
        {
          "id": "token_name",
          "type": "string",
          "title": "Token name",
          "default": "Animica Token",
          "ui": { "group": "meta", "order": 2 }
        },
        {
          "id": "token_symbol",
          "type": "string",
          "title": "Symbol",
          "description": "2–11 uppercase letters.",
          "string": { "pattern": "^[A-Z]{2,11}$" },
          "default": "ANM",
          "ui": { "group": "meta", "order": 3, "placeholder": "ANM" }
        },
        {
          "id": "decimals",
          "type": "integer",
          "title": "Decimals",
          "numeric": { "minimum": 0, "maximum": 18 },
          "default": 18,
          "ui": { "group": "meta", "order": 4 }
        },
        {
          "id": "initial_supply",
          "type": "integer",
          "title": "Initial supply (base units)",
          "description": "Total minted supply at deploy time.",
          "numeric": { "minimum": 0 },
          "default": 1000000000000000000,
          "ui": { "group": "dist", "order": 1 }
        },
        {
          "id": "owner_address",
          "type": "address",
          "title": "Owner address",
          "description": "anim1… (bech32m) or 0x… (20-byte hex).",
          "address_network": "animica",
          "ui": { "group": "dist", "order": 2, "placeholder": "anim1..." }
        },
        {
          "id": "enable_permit",
          "type": "boolean",
          "title": "Enable permit-style off-chain approvals",
          "default": true,
          "ui": { "group": "meta", "order": 5, "widget": "switch", "hint": "Uses PQ sign domain per spec." }
        },
        {
          "id": "chain_id",
          "type": "chain_id",
          "title": "Chain ID",
          "description": "1=mainnet, 2=testnet, 1337=devnet (default).",
          "numeric": { "minimum": 1 },
          "default": 1337,
          "ui": { "group": "chain", "order": 1 }
        },
        {
          "id": "rpc_url",
          "type": "url",
          "title": "RPC URL",
          "description": "Optional; used by helper scripts.",
          "required": false,
          "default": "http://127.0.0.1:8545",
          "ui": { "group": "chain", "order": 2, "placeholder": "https://rpc.animica.dev" }
        }
      ]
    }
  ],

  "$comment": "Implementers: this meta-schema is intentionally permissive (facets under 'string'/'numeric'). Tooling should translate these to concrete JSON Schema when emitting per-project values.json for CI validation."
}
