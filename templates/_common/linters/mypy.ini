# ----------------------------------------------------------------------
# mypy configuration (shared Animica template)
#
# This file is rendered into projects created by the template engine.
# It opts into a strict-but-practical baseline for production code,
# while relaxing rules for tests, scripts and generated artifacts.
#
# Template-aware variables (resolved at render time):
#   {{ python_version | default('3.11') }}     -> interpreter version for type-checking
#   {{ package_name  | default('animica') }}   -> primary first-party package (optional)
#
# You can override anything per-repo by adding a local mypy.ini or
# a [tool.mypy] table in pyproject.toml.
# ----------------------------------------------------------------------

[mypy]
python_version = {{ python_version | default('3.11') }}
# Cache/build settings
cache_dir = .mypy_cache
incremental = True
namespace_packages = True
explicit_package_bases = True

# Project layout: tune or override in leaf repos if needed.
# These are common roots across Animica projects; mypy will still
# follow imports from other locations when referenced.
files =
    core,
    pq,
    proofs,
    consensus,
    mining,
    p2p,
    rpc,
    execution,
    vm_py,
    capabilities,
    aicf,
    randomness,
    da,
    sdk/python,
    studio-services,
    contracts,
    templates,
    tests

# Exclude bulky or generated paths from discovery
# (regex; (?x) enables comments and whitespace).
exclude = (?x)(
    ^\.venv/|
    ^venv/|
    ^\.mypy_cache/|
    ^build/|
    ^dist/|
    ^node_modules/|
    ^site/|
    ^.*/__pycache__/|
    ^tests/(reports|artifacts)/|
    ^contracts/build/|
    ^ops/docker/config/grafana/dashboards/
)$

# Output / ergonomics
pretty = True
show_error_codes = True
show_error_context = True
error_summary = True
warn_unused_configs = True

# ----------------------------------------------------------------------
# Strictness:
# We start from mypy's "strict" profile and then dial back a few items
# that tend to be too noisy for large, multi-package repos.
# ----------------------------------------------------------------------

# Core “strict” toggles
warn_unused_ignores = True
warn_redundant_casts = True
warn_no_return = True
warn_return_any = True
warn_unreachable = True
no_implicit_optional = True
strict_equality = True

disallow_any_generics = True
disallow_subclassing_any = True
disallow_untyped_calls = True
disallow_untyped_defs = True
disallow_incomplete_defs = True
disallow_untyped_decorated_calls = True

check_untyped_defs = True
no_implicit_reexport = True

# Allow common dynamic patterns in large repos (relaxed vs full strict)
# Set to False globally; prefer per-module ignores below when possible.
# If you want maximum strictness, flip these to True.
allow_redefinition = False

# Third-party typing landscape is uneven. Default to *not* ignoring
# missing imports, then opt-out for specific modules below.
ignore_missing_imports = False

# Treat partial overlaps of TypedDicts as errors (safer default)
strict_optional = True

# ----------------------------------------------------------------------
# Per-path relaxations
# ----------------------------------------------------------------------

# Tests: allow asserts, fixtures, parametric “magic numbers”, and looser typing.
[mypy-tests.*]
disallow_untyped_defs = False
disallow_incomplete_defs = False
disallow_untyped_calls = False
check_untyped_defs = False
warn_unused_ignores = False
warn_return_any = False
allow_redefinition = True
ignore_missing_imports = True

# Benchmarks and fuzz targets: focus on runtime coverage over strict typing.
[mypy-tests.bench.*]
disallow_untyped_defs = False
disallow_untyped_calls = False
check_untyped_defs = False
warn_unused_ignores = False
ignore_missing_imports = True

[mypy-tests.fuzz.*]
disallow_untyped_defs = False
disallow_untyped_calls = False
check_untyped_defs = False
warn_unused_ignores = False
ignore_missing_imports = True

# Dev/ops scripts (Terraform/Ansible helpers, etc.) — pragmatic defaults.
[mypy-ops.*]
disallow_untyped_defs = False
disallow_untyped_calls = False
check_untyped_defs = False
ignore_missing_imports = True

# ----------------------------------------------------------------------
# Third-party libraries without complete type hints
# (Add or remove sections as your repo’s dependencies evolve.)
# Using per-module ignores ensures first-party code stays strict.
# ----------------------------------------------------------------------
[mypy-msgspec.*]
ignore_missing_imports = True

[mypy-rocksdb.*]
ignore_missing_imports = True

[mypy-prometheus_client.*]
ignore_missing_imports = True

[mypy-uvloop]
ignore_missing_imports = True

[mypy-websockets.*]
ignore_missing_imports = True

[mypy-aioquic.*]
ignore_missing_imports = True

[mypy-blake3]
ignore_missing_imports = True

[mypy-fastapi.*]
ignore_missing_imports = True

[mypy-starlette.*]
ignore_missing_imports = True

[mypy-ujson]
ignore_missing_imports = True

# Optional GPU backends (present in some environments only)
[mypy-pyopencl.*]
ignore_missing_imports = True

[mypy-numba.*]
ignore_missing_imports = True

# Optional cryptography/PQ backends
[mypy-oqs.*]
ignore_missing_imports = True

# ----------------------------------------------------------------------
# Plugin area (disabled by default, enable per repo if needed)
# ----------------------------------------------------------------------
# plugins =
#   pydantic.mypy
#
# [pydantic-mypy]
# init_forbid_extra = True
# init_typed = True
# warn_required_dynamic_aliases = True
