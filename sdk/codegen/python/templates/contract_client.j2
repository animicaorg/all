{#-
  Jinja2 template for generating a Python contract client.

  Expected context:
    class_name: str
    base_import: str  (e.g., "omni_sdk.contracts.client")
    base_class:  str  (e.g., "ContractClient")
    abi: dict-like normalized ABI (see sdk.codegen.common.model.AbiIR.to_dict())
    functions: list of FunctionIR-like dicts
    events:    list of EventIR-like dicts
    abi_json:  (optional) pre-serialized JSON string for `abi`; if absent, `abi|tojson` is used
-#}
# This file was generated by Animica SDK codegen.
# Do not edit by hand.

from __future__ import annotations
from typing import Any, Optional, List, Tuple, Dict
import json
from {{ base_import }} import {{ base_class }}

{# --- Helpers ------------------------------------------------------------- #}
{% macro py_ident(name) -%}
{%- set s = name|trim -%}
{%- set safe = [] -%}
{%- for ch in s -%}
  {%- if ch.isalnum() or ch == '_' -%}
    {%- do safe.append(ch) -%}
  {%- else -%}
    {%- do safe.append('_') -%}
  {%- endif -%}
{%- endfor -%}
{%- set out = safe|join('') if safe|length > 0 else '_unnamed' -%}
{%- if out[0].isdigit() -%}
  {%- set out = '_' ~ out -%}
{%- endif -%}
{%- if out in ('False','True','None','and','as','assert','break','class','continue','def','del','elif','else','except','finally','for','from','global','if','import','in','is','lambda','nonlocal','not','or','pass','raise','return','try','while','with','yield') -%}
  {{- out ~ '_' -}}
{%- else -%}
  {{- out -}}
{%- endif -%}
{%- endmacro %}

{% macro method_name(fn) -%}
{%- set base = py_ident(fn.name) -%}
{%- if fn.discriminator is defined and fn.discriminator -%}
  {{- base ~ '_' ~ fn.discriminator -}}
{%- else -%}
  {{- base -}}
{%- endif -%}
{%- endmacro %}

{% macro canonical_type(t) -%}
{%- set k = t.kind -%}
{%- if k in ('uint','int') -%}
  {{- k ~ (t.bits if t.bits is not none else '') -}}
{%- elif k == 'bytes' -%}
  {%- if t.bits is not none -%}
    {{- 'bytes' ~ (t.bits // 8) -}}
  {%- else -%}
    bytes
  {%- endif -%}
{%- elif k in ('bool','address','string') -%}
  {{- k -}}
{%- elif k == 'array' -%}
  {{- canonical_type(t.array_item) -}}{{ '[' ~ (t.array_len if t.array_len is not none else '') ~ ']' }}
{%- elif k == 'tuple' -%}
  ({{ t.tuple_elems|map('attribute','canonical_str')|join(',') }})
{%- else -%}
  any
{%- endif -%}
{%- endmacro %}

{% macro py_type_hint(t) -%}
{%- set k = t.kind -%}
{%- if k in ('uint','int') -%}
  int
{%- elif k == 'bool' -%}
  bool
{%- elif k == 'bytes' -%}
  bytes
{%- elif k == 'string' -%}
  str
{%- elif k == 'address' -%}
  str
{%- elif k == 'array' -%}
  List[{{ py_type_hint(t.array_item) }}]
{%- elif k == 'tuple' -%}
  {%- set elems = t.tuple_elems or [] -%}
  {%- if elems|length == 0 -%}
    Tuple[()]
  {%- elif elems|length == 1 -%}
    Tuple[{{ py_type_hint(elems[0]) }},]
  {%- else -%}
    Tuple[{% for e in elems -%}{{ py_type_hint(e) }}{{ ', ' if not loop.last else '' }}{%- endfor %}]
  {%- endif -%}
{%- else -%}
  Any
{%- endif -%}
{%- endmacro %}

{% macro return_hint(fn) -%}
{%- if fn.state_mutability in ('view','pure') -%}
  {%- if fn.outputs|length == 0 -%}
    Any
  {%- elif fn.outputs|length == 1 -%}
    {{ py_type_hint(fn.outputs[0]) }}
  {%- else -%}
    Tuple[{% for o in fn.outputs -%}{{ py_type_hint(o) }}{{ ', ' if not loop.last else '' }}{%- endfor %}]
  {%- endif -%}
{%- else -%}
  Any
{%- endif -%}
{%- endmacro %}

{% macro param_sig(p) -%}
{{ py_ident(p.name) }}: {{ py_type_hint(p.type) }}
{%- endmacro %}

{% macro args_for_call(fn) -%}
{%- for p in fn.inputs -%}
{{ py_ident(p.name) }}{{ ', ' if not loop.last else '' }}
{%- endfor -%}
{%- endmacro %}

{# --- ABI embedding ------------------------------------------------------- #}
{% set ABI_JSON = abi_json if abi_json is defined else abi|tojson %}
ABI: Dict[str, Any] = json.loads(r'''{{ ABI_JSON }}''')

SELECTORS: Dict[str, str] = {
{%- for fn in functions %}
    '{{ method_name(fn) }}': '{{ fn.selector }}'{{ ',' if not loop.last else '' }}
{%- endfor %}
}

TOPICS: Dict[str, str] = {
{%- for ev in events %}
    '{{ method_name(ev) }}': '{{ ev.topic_id }}'{{ ',' if not loop.last else '' }}
{%- endfor %}
}

class {{ class_name }}({{ base_class }}):
    """Strongly-typed client for this contract.

    Attributes
    ----------
    ABI : dict
        Canonical ABI used by this client.
    SELECTORS : dict[str, str]
        Function name → sha3-256 selector hex.
    TOPICS : dict[str, str]
        Event name → sha3-256 topic-id hex.
    """

    def __init__(
        self,
        address: str,
        *,
        rpc_url: Optional[str] = None,
        chain_id: Optional[int] = None,
        signer: Any = None,
        http_client: Any = None,
    ) -> None:
        """Create a client bound to `address`."""
        super().__init__(
            address=address,
            abi=ABI,
            rpc_url=rpc_url,
            chain_id=chain_id,
            signer=signer,
            http_client=http_client,
        )

{# --- Function methods ---------------------------------------------------- #}
{% for fn in functions %}

    def {{ method_name(fn) }}(self, {%- for p in fn.inputs -%}{{ param_sig(p) }}{{ ', ' if not loop.last else '' }}{%- endfor -%}) -> {{ return_hint(fn) }}:
        """{{ fn.name }} {{ fn.state_mutability }}

        Signature: ``{{ fn.signature }}``
        Selector: ``{{ fn.selector }}``
        Inputs: {%- if fn.inputs|length == 0 -%} —{%- else -%}
          {%- for p in fn.inputs -%}
            {{ ' ' if loop.first else '' }}{{ p.name }}:{{ canonical_type(p.type) }}{{ ',' if not loop.last else '' }}
          {%- endfor -%}
        {%- endif -%}
        Returns: {%- if fn.outputs|length == 0 -%} —{%- else -%}
          {%- for o in fn.outputs -%}
            {{ ' ' if loop.first else '' }}{{ canonical_type(o) }}{{ ',' if not loop.last else '' }}
          {%- endfor -%}
        {%- endif -%}
        """
        {%- if fn.state_mutability in ('view','pure') %}
        return self.call("{{ fn.name }}", [{{ args_for_call(fn) }}])
        {%- else %}
        return self.transact("{{ fn.name }}", [{{ args_for_call(fn) }}])
        {%- endif %}
{% endfor %}

    # --- Event helpers ---
    @property
    def event_topics(self) -> Dict[str, str]:
        """Expose event topic IDs (name → topic hex)."""
        return TOPICS
