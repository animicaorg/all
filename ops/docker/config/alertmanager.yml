# Alertmanager configuration for Animica docker-compose devnet
# Tip: environment variables in this file require starting Alertmanager with
#      --config.expand-env (set in your compose/entrypoint).

global:
  resolve_timeout: 5m

templates:
  - /etc/alertmanager/templates/*.tmpl

# ────────────────────────────────── Routing ──────────────────────────────────
route:
  receiver: blackhole
  group_by: ['alertname', 'job', 'instance']
  group_wait: 15s
  group_interval: 2m
  repeat_interval: 4h

  routes:
    # Critical → Slack (pager) + continue so other receivers may also fire
    - matchers:
        - severity="critical"
      receiver: slack_critical
      continue: true

    # Warning → Slack (warnings)
    - matchers:
        - severity="warning"
      receiver: slack_warning

    # Info → log-only (blackhole by default; switch to slack_info/email if desired)
    - matchers:
        - severity="info"
      receiver: log_only

# ─────────────────────────────── Inhibition rules ────────────────────────────
inhibit_rules:
  # If a critical alert is firing for same target, mute warning/info siblings
  - source_matchers: ['severity="critical"']
    target_matchers: ['severity=~"warning|info"']
    equal: ['alertname', 'job', 'instance']

  # If a warning exists, mute info-level duplicates
  - source_matchers: ['severity="warning"']
    target_matchers: ['severity="info"']
    equal: ['alertname', 'job', 'instance']

# ───────────────────────────────── Receivers ─────────────────────────────────
receivers:
  # Safe default: sink to an unroutable local endpoint (does not crash Alertmanager)
  - name: blackhole
    webhook_configs:
      - url: http://127.0.0.1:65535/
        send_resolved: true
        max_alerts: 10

  # Log-only placeholder (same sink). Swap to a real integration when ready.
  - name: log_only
    webhook_configs:
      - url: http://127.0.0.1:65535/
        send_resolved: true

  # Slack (warnings). Requires SLACK_WEBHOOK_URL and --config.expand-env.
  - name: slack_warning
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        send_resolved: true
        channel: '#animica-alerts'
        username: 'alertmanager'
        icon_emoji: ':warning:'
        title: '[WARNING] {{ .CommonLabels.alertname }}'
        text: >-
          {{ range .Alerts -}}
          • *{{ .Labels.instance | default "n/a" }}* — {{ .Annotations.summary | default .Annotations.description | default "no summary" }} ({{ .Status }})
          {{ end }}
        http_config:
          proxy_url: '${HTTP_PROXY}'

  # Slack (critical/pager). Use a separate webhook or channel if you prefer.
  - name: slack_critical
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL_CRITICAL}'
        send_resolved: true
        channel: '#animica-pager'
        username: 'alertmanager'
        icon_emoji: ':rotating_light:'
        title: '[CRITICAL] {{ .CommonLabels.alertname }}'
        text: >-
          *Firing:* {{ len .Alerts.Firing }}  |  *Resolved:* {{ len .Alerts.Resolved }}
          {{ range .Alerts -}}
          • *{{ .Labels.instance | default "n/a" }}* — {{ .Annotations.summary | default .Annotations.description | default "no summary" }}
          {{ end }}
        http_config:
          proxy_url: '${HTTP_PROXY}'

  # PagerDuty (optional). Set PAGERDUTY_ROUTING_KEY to enable.
  - name: pagerduty
    pagerduty_configs:
      - routing_key: '${PAGERDUTY_ROUTING_KEY}'
        send_resolved: true
        class: 'animica/devnet'
        component: '{{ .CommonLabels.job }}'
        group: '{{ .CommonLabels.instance }}'
        severity: '{{ .CommonLabels.severity | default "critical" }}'
        description: '{{ .CommonAnnotations.summary | default .CommonLabels.alertname }}'

# ─────────────────────────────── Time intervals (optional) ───────────────────
# time_intervals:
#   - name: work_hours
#     time_intervals:
#       - weekdays: ['monday:friday']
#         times:
#           - start_time: '09:00'
#             end_time: '18:00'

