# Grafana Loki â€” single-binary config, Docker-friendly (filesystem store)
# Works with ops/docker/docker-compose.observability.yml and Promtail shipping logs.
# Retention defaults to 14 days; tune as needed.

server:
  http_listen_port: 3100
  grpc_listen_port: 9096
  log_level: info

# Single-tenant for devnet/compose. Put a reverse proxy in front if multi-tenant auth is needed.
auth_enabled: false

# Ingest & lifecycle (single process / single replica)
ingester:
  lifecycler:
    address: 127.0.0.1
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1
    final_sleep: 0s
  chunk_idle_period: 5m         # flush chunks that are idle for 5m
  chunk_retain_period: 30s       # how long to keep flushed chunks in memory
  max_transfer_retries: 0

# Recommended boltdb-shipper + filesystem layout for local/docker.
schema_config:
  configs:
    - from: 2022-01-01
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

storage_config:
  boltdb_shipper:
    active_index_directory: /loki/index
    cache_location: /loki/boltdb-cache
    shared_store: filesystem
  filesystem:
    directory: /loki/chunks

# Compactor does retention & index compaction for boltdb-shipper.
compactor:
  working_directory: /loki/compactor
  shared_store: filesystem
  compaction_interval: 5m
  retention_enabled: true

# Global limits suitable for a small devnet; raise for heavier loads.
limits_config:
  ingestion_rate_mb: 16
  ingestion_burst_size_mb: 32
  per_stream_rate_limit: "4MB"
  per_stream_rate_limit_burst: "8MB"
  reject_old_samples: true
  reject_old_samples_max_age: 168h     # 7 days
  retention_period: 336h               # 14 days
  max_global_streams_per_user: 10000
  max_label_names_per_series: 30
  max_cache_freshness_per_query: 10m

# Query path (single-binary friendly). The scheduler is embedded and used by the worker.
query_range:
  parallelise_shardable_queries: true
  cache_results: true
  results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_items: 10240
        ttl: 5m

query_scheduler:
  max_outstanding_requests_per_tenant: 2048

frontend:
  log_queries_longer_than: 5s
  compress_responses: true

frontend_worker:
  scheduler_address: 127.0.0.1:9095

# Cache tuning (embedded cache for single node)
chunk_store_config:
  max_look_back_period: 0s

# Optional Loki ruler. Points to Alertmanager from the compose stack (may be absent; safe to leave).
ruler:
  enable_api: true
  enable_alertmanager_discovery: false
  alertmanager_url: http://alertmanager:9093
  storage:
    type: local
    local:
      directory: /loki/rules
  ring:
    kvstore:
      store: inmemory
  rule_path: /loki/rules-temp

# Tracing hook (off by default). Enable when Tempo is present.
# tracing:
#   enabled: true
#   otlp:
#     grpc:
#       endpoint: tempo:4317

# Metrics exposure (picked up by Prometheus in the compose file).
analytics:
  reporting_enabled: false
