{{-/*
Secret: Faucet private key (optional)

Render only when .Values.faucet.enabled is true.

Inputs (priority for key source):
- .Values.faucet.privateKeyB64  (already base64-encoded)
- .Values.faucet.privateKeyFile (path inside the chart; raw -> b64enc)
- .Values.faucet.privateKey     (raw plaintext -> b64enc)

Other options:
- .Values.faucet.secretName   : override name (default: "<release>-faucet")
- .Values.faucet.annotations  : extra annotations
- .Values.faucet.immutable    : Kubernetes immutable Secret (bool)

The key is exposed as data.FAUCET_KEY for studio-services to read.
*/ -}}
{{- if .Values.faucet.enabled }}
{{- $name := default (printf "%s-faucet" (include "animica-devnet.fullname" .)) .Values.faucet.secretName -}}

{{- /* Resolve a base64-encoded key from the available inputs */ -}}
{{- $b64 := "" -}}
{{- if .Values.faucet.privateKeyB64 -}}
  {{- $b64 = .Values.faucet.privateKeyB64 -}}
{{- else if .Values.faucet.privateKeyFile -}}
  {{- $b64 = ( .Files.Get .Values.faucet.privateKeyFile | b64enc ) -}}
{{- else if .Values.faucet.privateKey -}}
  {{- $b64 = ( .Values.faucet.privateKey | b64enc ) -}}
{{- end -}}
{{- if not $b64 -}}
  {{- fail "faucet.enabled=true but no faucet.privateKey/privateKeyFile/privateKeyB64 supplied" -}}
{{- end -}}

apiVersion: v1
kind: Secret
metadata:
  name: {{ $name | quote }}
  labels:
    {{- include "animica-devnet.labels" (dict "ctx" . "component" "faucet") | nindent 4 }}
  {{- with .Values.faucet.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
{{- if hasKey .Values.faucet "immutable" }}
immutable: {{ .Values.faucet.immutable | default false }}
{{- end }}
type: Opaque
data:
  FAUCET_KEY: {{ $b64 | quote }}
{{- end }}
