# Default values for the Animica Devnet Helm chart.
# Tweak as needed, then:  helm install animica-devnet ./ops/helm/animica-devnet -n animica-devnet --create-namespace

# ------------------------------------------------------------------------------
# Global settings
# ------------------------------------------------------------------------------
global:
  namespace: animica-devnet
  image:
    registry: ghcr.io/animica-org
    pullPolicy: IfNotPresent
    pullSecrets: []  # e.g. ['regcred']
  chain:
    id: 1337
    # Embedded spec/params.yaml used by node/miner and exposed to other services.
    paramsYaml: |
      # Minimal, devnet-biased chain parameters (trimmed for example).
      chainId: 1337
      consensus:
        block_target_seconds: 6
        max_tx_per_block: 2000
        randomness:
          commit_phase_seconds: 6
          reveal_phase_seconds: 6
          settle_phase_seconds: 0
          round_length_seconds: 12
          vdf:
            security_bits: 128
            discriminant_size_bits: 2048
            target_seconds: 5.0
      economics:
        base_reward: 5000000000000000   # 0.005 ANM (example)
        treasury_split: 0.10
        miner_split: 0.90
      gas:
        # Kept small for devnet UX
        min_price: 1
        block_gas_limit: 30000000
      poies_policy:
        gamma_cap: 1.0
        escort_q: 0.25
        per_type_caps:
          hash: 1.0
          ai: 0.5
          quantum: 0.25
          storage: 0.25
          vdf: 0.25

  # Embed a tiny genesis state/header for devnet bring-up.
  genesisJson: |
    {
      "chainId": 1337,
      "height": 0,
      "timestamp": 1700000000,
      "alloc": {
        "anim1qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq9z2r9v": { "balance": "1000000000000000000000" },
        "anim1qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq0s3u9k": { "balance": "1000000000000000000000" }
      },
      "roots": {
        "stateRoot": "0x00",
        "txsRoot": "0x00",
        "receiptsRoot": "0x00",
        "proofsRoot": "0x00",
        "daRoot": "0x00",
        "randomnessRoot": "0x00"
      },
      "theta": 1000000,
      "nonceDomain": "animica/genesis/1337",
      "mixSeed": "0x01"
    }

  # Initial P2P seed list (can be DNS names or /ip/â€¦-style multiaddrs if supported).
  seeds:
    - "seed1.animica.internal:37000"
    - "seed2.animica.internal:37000"

# ------------------------------------------------------------------------------
# Common k8s knobs (can be overridden per component)
# ------------------------------------------------------------------------------
common:
  podLabels: {}
  podAnnotations: {}
  nodeSelector: {}
  tolerations: []
  topologySpreadConstraints: []
  priorityClassName: ""
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    fsGroupChangePolicy: OnRootMismatch
    seccompProfile:
      type: RuntimeDefault
  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop: ["ALL"]

# ------------------------------------------------------------------------------
# Node (stateful set)
# ------------------------------------------------------------------------------
node:
  enabled: true
  image:
    repository: node
    tag: latest
  replicas: 1
  service:
    type: ClusterIP
    rpc:
      enabled: true
      port: 8545
    ws:
      enabled: true
      port: 8546
    p2pTcp:
      enabled: true
      port: 37000
    p2pQuic:
      enabled: true
      port: 37001
  persistence:
    enabled: true
    size: 20Gi
    storageClassName: ""  # inherit default if empty
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "2"
      memory: "4Gi"
  env:
    # Extra env pairs injected into container
    - name: ANIMICA_LOG_LEVEL
      value: "info"
  # Values fed into a rendered node.toml
  config:
    db:
      path: "/var/lib/animica/db"
      backend: "sqlite"
    rpc:
      host: "0.0.0.0"
      port: 8545
      wsPort: 8546
      corsOrigins: ["*"]
      rateLimits:
        maxRps: 200
        burst: 400
    p2p:
      listenAddrs:
        - "0.0.0.0:37000/tcp"
        - "0.0.0.0:37001/quic"
      maxPeers: 64
      seedsFromValues: true
    explorer:
      enableMetrics: true
    randomness:
      enableVdfVerify: true
  serviceMonitor:
    enabled: false   # Turn on if Prometheus Operator is installed
    interval: 15s
    scrapeTimeout: 10s
    labels: {}

# ------------------------------------------------------------------------------
# Miner (Deployment; can autoscale)
# ------------------------------------------------------------------------------
miner:
  enabled: true
  image:
    repository: miner
    tag: latest
  replicas: 1
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 5
    targetCPUUtilizationPercentage: 80
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "2"
      memory: "2Gi"
  env:
    - name: ANIMICA_MINER_DEVICE
      value: "cpu"
  config:
    rpcUrl: "http://animica-node:8545"
    wsUrl: "ws://animica-node:8546"
    threads: 2
    shareTarget: "auto"
  serviceMonitor:
    enabled: false
    interval: 30s
    scrapeTimeout: 10s
    labels: {}

# ------------------------------------------------------------------------------
# Explorer API
# ------------------------------------------------------------------------------
explorer:
  enabled: true
  image:
    repository: explorer
    tag: latest
  service:
    type: ClusterIP
    port: 8080
  resources:
    requests:
      cpu: "200m"
      memory: "256Mi"
    limits:
      cpu: "1"
      memory: "1Gi"
  config:
    rpcUrl: "http://animica-node:8545"
    wsUrl: "ws://animica-node:8546"
    cacheSeconds: 2
  serviceMonitor:
    enabled: false

# ------------------------------------------------------------------------------
# Studio Services (FastAPI proxy for deploy/verify/faucet/artifacts)
# ------------------------------------------------------------------------------
services:
  enabled: true
  image:
    repository: studio-services
    tag: latest
  service:
    type: ClusterIP
    port: 9000
  resources:
    requests:
      cpu: "200m"
      memory: "256Mi"
    limits:
      cpu: "1"
      memory: "1Gi"
  env:
    RPC_URL: "http://animica-node:8545"
    CHAIN_ID: "1337"
    STORAGE_DIR: "/var/lib/animica/services"
    RATE_LIMITS: "deploy=10r/s,verify=5r/s"
    CORS_ALLOWLIST: "*"   # tighten in real deployments
  persistence:
    enabled: true
    size: 5Gi
    storageClassName: ""
  serviceMonitor:
    enabled: false

# ------------------------------------------------------------------------------
# Web UIs (static sites)
# ------------------------------------------------------------------------------
studioWeb:
  enabled: true
  image:
    repository: studio-web
    tag: latest
  service:
    type: ClusterIP
    port: 80
  env:
    VITE_RPC_URL: "https://rpc.devnet.local"        # overridden by ingress/hostnames or dev proxy
    VITE_CHAIN_ID: "1337"
    VITE_SERVICES_URL: "https://services.devnet.local"
  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
    limits:
      cpu: "300m"
      memory: "256Mi"

explorerWeb:
  enabled: true
  image:
    repository: explorer-web
    tag: latest
  service:
    type: ClusterIP
    port: 80
  env:
    VITE_RPC_URL: "https://rpc.devnet.local"
    VITE_CHAIN_ID: "1337"
    VITE_EXPLORER_API: "https://explorer.devnet.local/api"
    VITE_SERVICES_URL: "https://services.devnet.local"
  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
    limits:
      cpu: "300m"
      memory: "256Mi"

# ------------------------------------------------------------------------------
# Ingress (single fanout ingress to multiple backends)
# ------------------------------------------------------------------------------
ingress:
  enabled: true
  className: nginx
  annotations: {}
  tls:
    enabled: false
    secretName: ""   # e.g. animica-tls
  hosts:
    rpc:
      host: rpc.devnet.local
      path: /rpc
      wsPath: /ws
    explorer:
      host: api.devnet.local
      basePath: /
    services:
      host: services.devnet.local
      basePath: /
    studioWeb:
      host: studio.devnet.local
      basePath: /
    explorerWeb:
      host: explorer.devnet.local
      basePath: /

# ------------------------------------------------------------------------------
# Observability toggles (assumes external stacks unless noted)
# ------------------------------------------------------------------------------
observability:
  prometheus:
    serviceMonitorEnabled: false
  grafana:
    enabled: false
  loki:
    enabled: false
  tempo:
    enabled: false

# ------------------------------------------------------------------------------
# RBAC & Service Accounts
# ------------------------------------------------------------------------------
rbac:
  create: true
serviceAccount:
  create: true
  name: ""   # autogenerated if empty
  annotations: {}

# ------------------------------------------------------------------------------
# Advanced: extra volumes/mounts or env to inject per component
# ------------------------------------------------------------------------------
extras:
  node:
    extraEnv: []
    extraVolumeMounts: []
    extraVolumes: []
  miner:
    extraEnv: []
    extraVolumeMounts: []
    extraVolumes: []
  explorer:
    extraEnv: []
    extraVolumeMounts: []
    extraVolumes: []
  services:
    extraEnv: []
    extraVolumeMounts: []
    extraVolumes: []
  studioWeb:
    extraEnv: []
    extraVolumeMounts: []
    extraVolumes: []
  explorerWeb:
    extraEnv: []
    extraVolumeMounts: []
    extraVolumes: []
