---
# -----------------------------------------------------------------------------
# Role: node
# Tasks: provision a single Animica node (RPC+WS+P2P) using Docker Compose.
# Expects group_vars/all.yml (or host_vars) to define ports, paths, and images.
# -----------------------------------------------------------------------------

- name: "Assert required vars present"
  ansible.builtin.assert:
    that:
      - chain_id is defined
      - images.node.repo is defined
      - images.node.tag is defined
      - animica_root_dir is defined
      - animica_compose_dir is defined
      - node_data_dir is defined
      - node_config_dir is defined
      - genesis_json_src is defined
      - chain_params_yaml_src is defined

- name: "Install common packages"
  ansible.builtin.package:
    name: "{{ packages_common | default([]) }}"
    state: present
  when: packages_common is defined and packages_common | length > 0
  become: true

- name: "Ensure docker engine is present (Debian/Ubuntu)"
  ansible.builtin.package:
    name:
      - docker.io
      - docker-compose-plugin
    state: present
  when:
    - docker.install | default(true)
    - ansible_facts['os_family'] == "Debian"
  become: true

- name: "Ensure docker engine is present (RHEL/CentOS/Fedora)"
  ansible.builtin.package:
    name:
      - docker
      - docker-compose-plugin
    state: present
  when:
    - docker.install | default(true)
    - ansible_facts['os_family'] in ["RedHat", "Rocky", "AlmaLinux", "Fedora"]
  become: true

- name: "Ensure docker service is started"
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true
  become: true

- name: "Create animica group"
  ansible.builtin.group:
    name: "{{ animica_group | default('animica') }}"
    state: present
  become: true

- name: "Create animica user"
  ansible.builtin.user:
    name: "{{ animica_user | default('animica') }}"
    group: "{{ animica_group | default('animica') }}"
    create_home: false
    shell: /usr/sbin/nologin
    system: true
  become: true

- name: "Add animica user to docker group"
  ansible.builtin.user:
    name: "{{ animica_user | default('animica') }}"
    groups: docker
    append: true
  become: true

- name: "Create base directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ animica_user | default('animica') }}"
    group: "{{ animica_group | default('animica') }}"
    mode: "0755"
  loop:
    - "{{ animica_root_dir }}"
    - "{{ animica_compose_dir }}"
    - "{{ animica_etc_dir }}"
    - "{{ node_config_dir }}"
    - "{{ node_data_dir }}"
  become: true

- name: "Copy genesis.json onto target"
  ansible.builtin.copy:
    src: "{{ genesis_json_src }}"
    dest: "{{ node_config_dir }}/genesis.json"
    owner: "{{ animica_user | default('animica') }}"
    group: "{{ animica_group | default('animica') }}"
    mode: "0644"
  become: true

- name: "Copy chain params (params.yaml) onto target"
  ansible.builtin.copy:
    src: "{{ chain_params_yaml_src }}"
    dest: "{{ node_config_dir }}/params.yaml"
    owner: "{{ animica_user | default('animica') }}"
    group: "{{ animica_group | default('animica') }}"
    mode: "0644"
  become: true

# Compute a few handy strings for templating config / compose
- name: "Set derived variables for ports & lists"
  ansible.builtin.set_fact:
    _rpc_bind_http: "{{ node_rpc_host | default('0.0.0.0') }}:{{ node_rpc_port_http | default(8545) }}"
    _rpc_bind_ws:   "{{ node_rpc_host | default('0.0.0.0') }}:{{ node_rpc_port_ws | default(8546) }}"
    _p2p_tcp_port:  "{{ (p2p_tcp_port | default(31002)) | int }}"
    _p2p_ws_port:   "{{ (p2p_ws_port  | default(31003)) | int }}"
    _p2p_quic_port: "{{ (p2p_quic_port | default('31001/udp') | string ).split('/')[0] | int }}"
    _bootstrap_nodes_csv: "{{ (bootstrap_nodes | default([])) | join(',') }}"
    _dns_seeds_csv: "{{ (dns_seeds | default([])) | join(',') }}"
    _cors_csv: "{{ (cors_allowlist | default([])) | join(',') }}"
    _rate_default_rps: "{{ rpc_rate_limits.default_rps | default(10) }}"
    _rate_burst: "{{ rpc_rate_limits.burst | default(50) }}"

- name: "Render node TOML config"
  ansible.builtin.copy:
    dest: "{{ node_config_dir }}/node.toml"
    owner: "{{ animica_user | default('animica') }}"
    group: "{{ animica_group | default('animica') }}"
    mode: "0644"
    content: |
      # Autogenerated by Ansible at {{ ansible_date_time.iso8601 }}
      [chain]
      chain_id = {{ chain_id }}

      [paths]
      data_dir = "{{ node_data_dir }}"
      genesis_json = "{{ node_config_dir }}/genesis.json"
      params_yaml  = "{{ node_config_dir }}/params.yaml"

      [logging]
      level = "{{ node_log_level | default('info') }}"

      [rpc]
      # Bind addresses (host:port)
      http_bind = "{{ _rpc_bind_http }}"
      ws_bind   = "{{ _rpc_bind_ws }}"
      cors_allowlist = [{{ cors_allowlist | default([]) | map('to_json') | join(', ') }}]

      [rpc.rate_limits]
      default_rps = {{ _rate_default_rps }}
      burst = {{ _rate_burst }}

      [p2p]
      tcp_port  = {{ _p2p_tcp_port }}
      ws_port   = {{ _p2p_ws_port }}
      quic_port = {{ _p2p_quic_port }}
      bootstrap_nodes = [{{ bootstrap_nodes | default([]) | map('to_json') | join(', ') }}]
      dns_seeds = [{{ dns_seeds | default([]) | map('to_json') | join(', ') }}]
  become: true

- name: "Write Docker Compose file for animica-node"
  ansible.builtin.copy:
    dest: "{{ animica_compose_dir }}/node.docker-compose.yml"
    owner: "{{ animica_user | default('animica') }}"
    group: "{{ animica_group | default('animica') }}"
    mode: "0644"
    content: |
      # Autogenerated by Ansible at {{ ansible_date_time.iso8601 }}
      services:
        animica-node:
          image: "{{ images.node.repo }}:{{ images.node.tag }}"
          container_name: animica-node
          restart: unless-stopped
          user: "0:0"
          environment:
            # The image entrypoint can read these or the mounted TOML below.
            CHAIN_ID: "{{ chain_id }}"
            LOG_LEVEL: "{{ node_log_level | default('info') }}"
            BOOTSTRAP_NODES: "{{ _bootstrap_nodes_csv }}"
            DNS_SEEDS: "{{ _dns_seeds_csv }}"
            CORS_ALLOWLIST: "{{ _cors_csv }}"
          volumes:
            - "{{ node_data_dir }}:/var/lib/animica"
            - "{{ node_config_dir }}:/app/config:ro"
          ports:
            - "{{ node_rpc_host | default('0.0.0.0') }}:{{ node_rpc_port_http | default(8545) }}:{{ node_rpc_port_http | default(8545) }}"
            - "{{ node_rpc_host | default('0.0.0.0') }}:{{ node_rpc_port_ws   | default(8546) }}:{{ node_rpc_port_ws   | default(8546) }}"
            - "{{ _p2p_tcp_port }}:{{ _p2p_tcp_port }}"
            - "{{ _p2p_ws_port }}:{{ _p2p_ws_port }}"
            - "{{ _p2p_quic_port }}:{{ _p2p_quic_port }}/udp"
          healthcheck:
            test: ["CMD-SHELL", "curl -sf http://127.0.0.1:{{ node_rpc_port_http | default(8545) }}/healthz || exit 1"]
            interval: 15s
            timeout: 5s
            retries: 20
          # Drop NET_RAW if possible; adjust per networking needs
          cap_drop: ["NET_RAW"]
      networks:
        default:
          name: animica
          driver: bridge
  become: true

- name: "Bring up node with docker compose"
  ansible.builtin.shell: |
    set -euo pipefail
    docker compose -f "{{ animica_compose_dir }}/node.docker-compose.yml" up -d
  args:
    executable: /bin/bash
  become: true

- name: "Wait for RPC to become healthy"
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ node_rpc_port_http | default(8545) }}/healthz"
    method: GET
    status_code: 200
  register: _health
  retries: 30
  delay: 5
  until: _health.status == 200

# Optional firewall management (best-effort)
- name: "Open firewall ports with firewalld (RHEL family)"
  when:
    - firewall.enabled | default(false)
    - ansible_facts['os_family'] in ["RedHat", "Rocky", "AlmaLinux", "Fedora"]
  become: true
  block:
    - name: "Ensure firewalld is running"
      ansible.builtin.service:
        name: firewalld
        state: started
        enabled: true
    - name: "Allow TCP ports"
      ansible.posix.firewalld:
        port: "{{ item }}/tcp"
        permanent: true
        immediate: true
        state: enabled
      loop:
        - "{{ node_rpc_port_http | default(8545) }}"
        - "{{ node_rpc_port_ws   | default(8546) }}"
        - "{{ _p2p_tcp_port }}"
        - "{{ _p2p_ws_port }}"
    - name: "Allow QUIC UDP port"
      ansible.posix.firewalld:
        port: "{{ _p2p_quic_port }}/udp"
        permanent: true
        immediate: true
        state: enabled

- name: "Open firewall ports with UFW (Debian family)"
  when:
    - firewall.enabled | default(false)
    - ansible_facts['os_family'] == "Debian"
  become: true
  block:
    - name: "Ensure UFW is installed"
      ansible.builtin.package:
        name: ufw
        state: present
    - name: "Allow TCP ports"
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - "{{ node_rpc_port_http | default(8545) }}"
        - "{{ node_rpc_port_ws   | default(8546) }}"
        - "{{ _p2p_tcp_port }}"
        - "{{ _p2p_ws_port }}"
    - name: "Allow QUIC UDP port"
      community.general.ufw:
        rule: allow
        port: "{{ _p2p_quic_port }}"
        proto: udp
    - name: "Enable UFW (non-interactive)"
      community.general.ufw:
        state: enabled

- name: "Summary â€” node online"
  ansible.builtin.debug:
    msg:
      - "Animica node is up."
      - "RPC HTTP: http://{{ node_rpc_host | default('0.0.0.0') }}:{{ node_rpc_port_http | default(8545) }}"
      - "RPC  WS : ws://{{ node_rpc_host | default('0.0.0.0') }}:{{ node_rpc_port_ws   | default(8546) }}"
      - "P2P TCP : {{ _p2p_tcp_port }}, WS: {{ _p2p_ws_port }}, QUIC/UDP: {{ _p2p_quic_port }}"
