# {{ ansible_managed | default('Autogenerated by Ansible') }}
# Animica node configuration (TOML) — rendered by Ansible.
# Safe defaults are provided; tune via group_vars/host_vars.
#
# Common vars:
#   chain_id: 1|2|1337 (default 1337)
#   chain_name: e.g. "devnet"
#   genesis_json_path: absolute path to genesis.json
#   params_yaml_path: absolute path to params.yaml (optional)
#   db_engine: "sqlite"|"rocksdb" (default "sqlite")
#   db_path: data path for DB (default: /var/lib/animica/node.db or rocks path)
#   rpc_host/rpc_port/ws_port: bind addresses
#   cors_allowlist: list of origins for RPC (array)
#   p2p_listen_tcp/quic/ws: "[::]:port" style (strings)
#   seed_nodes: list of multiaddr-like strings
#   metrics_port: 9100+
#   log_level: "info"|"debug"|"warning"|"error"
#   mempool_max_txs/mempool_max_bytes/min_gas_price: ints
#   randomness_*: beacon knobs; see section below
#   da_*: DA service knobs; see section below
#   aicf_*: AI Compute Fund knobs; see section below

[chain]
id = {{ chain_id | default(1337) }}
name = "{{ chain_name | default('devnet') }}"
{% if params_yaml_path is defined %}
params_path = "{{ params_yaml_path }}"
{% endif %}
genesis_path = "{{ genesis_json_path | default('/etc/animica/genesis.json') }}"

[paths]
data_dir = "{{ animica_data_dir | default('/var/lib/animica') }}"
temp_dir = "{{ animica_temp_dir | default('/var/tmp/animica') }}"
artifacts_dir = "{{ animica_artifacts_dir | default('/var/lib/animica/artifacts') }}"

[logging]
level = "{{ log_level | default('info') }}"
format = "{{ log_format | default('json') }}"   # "json"|"text"
color = {{ log_color | default(true) | tojson }}

[metrics]
enabled = {{ metrics_enabled | default(true) | tojson }}
addr = "{{ metrics_addr | default('0.0.0.0') }}"
port = {{ metrics_port | default(9108) }}
path = "{{ metrics_path | default('/metrics') }}"

[db]
engine = "{{ db_engine | default('sqlite') }}"   # "sqlite" or "rocksdb"
{% if (db_engine | default('sqlite')) == 'sqlite' %}
uri = "sqlite:///{{ db_path | default('/var/lib/animica/node.db') }}"
{% else %}
path = "{{ db_path | default('/var/lib/animica/rocks') }}"
{% endif %}
# generic tunables (applied where supported)
max_connections = {{ db_max_conns | default(64) }}
sync_writes = {{ db_sync_writes | default(true) | tojson }}

[rpc]
enabled = {{ rpc_enabled | default(true) | tojson }}
host = "{{ rpc_host | default('0.0.0.0') }}"
port = {{ rpc_port | default(8545) }}
ws_port = {{ ws_port | default(8546) }}
request_body_limit_bytes = {{ rpc_body_limit | default(4_194_304) }}   # 4 MiB
cors_allowlist = [
{% for origin in (cors_allowlist | default(['http://localhost:5173','http://127.0.0.1:5173'])) -%}
  "{{ origin }}"{% if not loop.last %},{% endif %}
{%- endfor %}
]
rate_limit_per_ip = {{ rpc_rate_limit_per_ip | default(50) }}          # req/s token bucket
rate_burst_per_ip = {{ rpc_rate_burst_per_ip | default(150) }}

[p2p]
enabled = {{ p2p_enabled | default(true) | tojson }}
node_key_path = "{{ p2p_node_key_path | default('/etc/animica/p2p.key') }}"
identity_alg = "{{ p2p_identity_alg | default('dilithium3') }}"
listen_tcp = "{{ p2p_listen_tcp | default('0.0.0.0:30333') }}"
listen_quic = "{{ p2p_listen_quic | default('0.0.0.0:30334') }}"
listen_ws = "{{ p2p_listen_ws | default('0.0.0.0:30335') }}"
max_peers = {{ p2p_max_peers | default(80) }}
dial_concurrency = {{ p2p_dial_concurrency | default(16) }}
ws_allowed_origins = [
{% for origin in (p2p_ws_allowed_origins | default(['*'])) -%}
  "{{ origin }}"{% if not loop.last %},{% endif %}
{%- endfor %}
]
seeds = [
{% for s in (seed_nodes | default([])) -%}
  "{{ s }}"{% if not loop.last %},{% endif %}
{%- endfor %}
]
# transport toggles
enable_tcp = {{ p2p_enable_tcp | default(true) | tojson }}
enable_quic = {{ p2p_enable_quic | default(true) | tojson }}
enable_ws = {{ p2p_enable_ws | default(false) | tojson }}

[consensus]
# Policy/config roots (optional explicit paths; otherwise read from [chain].params_path)
poies_policy_path = "{{ poies_policy_path | default('/etc/animica/poies_policy.yaml') }}"
alg_policy_root = "{{ alg_policy_root | default('0x' ~ ('0' * 64)) }}"
theta_initial = {{ theta_initial | default(1_000_000) }}    # µ-nats target
retarget_window_blocks = {{ retarget_window_blocks | default(64) }}
retarget_ema_alpha_milli = {{ retarget_ema_alpha_milli | default(120) }}  # 0.120

[mempool]
max_txs = {{ mempool_max_txs | default(50000) }}
max_bytes = {{ mempool_max_bytes | default(256*1024*1024) }}  # 256 MiB
min_gas_price = {{ min_gas_price | default(1) }}
ttl_seconds = {{ mempool_ttl_seconds | default(3600) }}
per_sender_queue_max = {{ mempool_per_sender_max | default(1024) }}
replace_by_fee_ratio_milli = {{ rbf_ratio_milli | default(1250) }}  # +25%

[randomness]
enabled = {{ randomness_enabled | default(true) | tojson }}
round_seconds = {{ randomness_round_seconds | default(60) }}
commit_phase_seconds = {{ randomness_commit_seconds | default(20) }}
reveal_phase_seconds = {{ randomness_reveal_seconds | default(20) }}
settle_phase_seconds = {{ randomness_settle_seconds | default(20) }}
vdf_security_bits = {{ vdf_security_bits | default(128) }}
vdf_discriminant_bits = {{ vdf_discriminant_bits | default(2048) }}
vdf_target_seconds = {{ vdf_target_seconds | default(18) }}
qrng_enable = {{ qrng_enable | default(false) | tojson }}

[da]
enabled = {{ da_enabled | default(true) | tojson }}
max_blob_bytes = {{ da_max_blob_bytes | default(4*1024*1024) }}  # 4 MiB
erasure_k = {{ da_erasure_k | default(16) }}
erasure_n = {{ da_erasure_n | default(32) }}
sampler_target_p_fail_e6 = {{ da_target_p_fail_e6 | default(10) }}  # 1e-5 expressed as 10
api_bind = "{{ da_api_bind | default('0.0.0.0:8667') }}"

[aicf]
enabled = {{ aicf_enabled | default(true) | tojson }}
epoch_seconds = {{ aicf_epoch_seconds | default(600) }}
split_provider = {{ aicf_split_provider | default(70) }}
split_treasury = {{ aicf_split_treasury | default(20) }}
split_miner = {{ aicf_split_miner | default(10) }}
sla_traps_min_ratio_milli = {{ aicf_sla_traps_min_ratio_milli | default(700) }}

[capabilities]
enable_blob_pin = {{ cap_enable_blob_pin | default(true) | tojson }}
enable_ai_enqueue = {{ cap_enable_ai_enqueue | default(true) | tojson }}
enable_quantum_enqueue = {{ cap_enable_quantum_enqueue | default(true) | tojson }}
enable_zk_verify = {{ cap_enable_zk_verify | default(true) | tojson }}
queue_max_inflight = {{ cap_queue_max_inflight | default(1024) }}

[limits]
max_block_bytes = {{ max_block_bytes | default(2*1024*1024) }}
max_block_gas = {{ max_block_gas | default(10_000_000) }}
tx_max_bytes = {{ tx_max_bytes | default(256*1024) }}
tx_sig_verify_timeout_ms = {{ tx_sig_verify_timeout_ms | default(150) }}

# Optional feature flags (rollout toggles)
[features]
enable_vm_py_contracts = {{ feature_vm_py | default(true) | tojson }}
enable_ws_streams = {{ feature_ws_streams | default(true) | tojson }}
strict_cbor = {{ feature_strict_cbor | default(true) | tojson }}
