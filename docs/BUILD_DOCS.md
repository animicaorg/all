# Building & Validating Docs (How the Website Consumes This Folder)

This document explains how the **website** project pulls Markdown/MDX from `/docs`, how navigation is wired via `docs/SIDEBAR.yaml`, and which checks run locally and in CI.

> TL;DR:
> - Source-of-truth prose lives in this `/docs` folder.
> - The website optionally **syncs** a subset into `website/src/docs/` at build time.
> - A sidebar tree in `docs/SIDEBAR.yaml` defines the nav order/labels.
> - CI validates links, slugs, and redirects so we don’t ship broken docs.

---

## 1) Where content lives

- **Authoring source:** this repo’s `/docs` directory (Markdown/MDX).
- **Website runtime copy:** `website/src/docs/` (generated by a sync script).
- **Nav metadata:** `docs/SIDEBAR.yaml` (stable paths/titles).
- **Legal pages:** also duplicated under `website/content/legal/` for static hosting.

You can keep **all** docs in `/docs/` and let the website pull the pieces it needs.

---

## 2) How the website pulls docs

There is an optional sync script in the website app that mirrors a subset of files:

website/scripts/sync_docs_from_repo.mjs

### Local dev

From the `website/` directory:

```bash
# one-time install
pnpm install

# pull the latest docs into website/src/docs (idempotent)
node scripts/sync_docs_from_repo.mjs

# start the dev server
pnpm dev

This will:
	1.	Create or update website/src/docs/… with selected files from /docs.
	2.	Copy docs/SIDEBAR.yaml so the website can render the sidebar tree.
	3.	Print a short summary of added/updated files.

The sync script is optional. If you skip it, the website’s /docs/[...slug] route will redirect to the canonical docs (e.g., GitHub) rather than serve embedded MDX.

⸻

3) Routing & slugs

The website has a server/edge handler:

website/src/pages/docs/[...slug].ts

Resolution logic at request time:
	1.	If a matching MDX exists under website/src/docs/<SLUG>.mdx or .md → serve it using the Docs layout.
	2.	Otherwise → redirect to the canonical docs URL (computed from slug), keeping anchors/query.

Slug convention
	•	Slugs should match file basenames without extension.
	•	Example: docs/QUICKSTART.mdx → /docs/QUICKSTART
	•	Ensure Sidebar entries use the same slug casing.

⸻

4) Navigation (SIDEBAR.yaml)
	•	docs/SIDEBAR.yaml is the single source of truth for the sidebar order/labels.
	•	The website loads it during build/dev and renders a nested sidebar.
	•	Each item can have:
	•	title (required)
	•	href (route or absolute URL)
	•	slug (for on-site MDX under /docs/)
	•	children (nested items)
	•	note (short hint text)

Best practices
	•	Do not rename existing slugs casually (they become user-visible permalinks).
	•	New sections should be appended to avoid breaking deep links.
	•	If you must rename, add a redirect rule (see §7).

⸻

5) Validation & quality gates

Validation occurs locally (via scripts) and in CI:

a) Sidebar schema & slug checks
	•	The website loader validates YAML structure and ensures:
	•	title present
	•	href or slug present
	•	Any slug either has a matching website/src/docs/<slug>.mdx? or is redirectable

If a slug is missing locally, it is not a hard error if a redirect target exists.

b) MD/MDX parsing
	•	Astro/MDX compile during pnpm build.
	•	Frontmatter is optional; the site uses sidebar titles by default.

c) Link checking
	•	website/scripts/check_links.mjs scans internal links and verifies:
	•	On-site routes (e.g., /docs/…) resolve to either a baked MDX page or a redirect
	•	External links respond with non-4xx
	•	CI runs this in website/.github/workflows/build.yml.

d) Dead anchors
	•	The site enables rehype-slug for headings, so #heading-ids stabilize.
	•	The link checker warns when a local anchor is missing.

e) Lint & formatting
	•	ESLint/Prettier in the website project also lint MDX where possible.
	•	Markdown style guidance lives in docs/STYLE_GUIDE.md.

⸻

6) CI flow (high level)

Website workflows:
	•	Build & unit tests: website/.github/workflows/build.yml
	•	Install, typecheck, build
	•	Run node scripts/check_links.mjs
	•	E2E (routing & basics): website/.github/workflows/e2e.yml
	•	Spins a mocked RPC
	•	Validates docs routes/redirects
	•	Deploy (optional): deploy-vercel.yml / deploy-netlify.yml

Artifacts (if any) are uploaded for inspection.

⸻

7) Redirects & canonical links

If a page is not embedded locally:
	•	The docs route uses environment-computed canonical URLs (see website/src/config/links.ts and website/src/env.ts).
	•	Netlify/Vercel config can add static redirects:
	•	Netlify: website/_redirects
	•	Vercel: website/vercel.json

Examples:

/docs/LEGACY   https://github.com/animica-labs/repo/blob/main/docs/LEGACY.md  301


⸻

8) Adding / renaming / moving docs (step-by-step)

Add a page
	1.	Create docs/MY_PAGE.mdx (follow STYLE_GUIDE.md).
	2.	Append an entry to docs/SIDEBAR.yaml with title + slug: MY_PAGE.
	3.	(Optional) Embed locally:
	•	Run node website/scripts/sync_docs_from_repo.mjs
	•	Confirm website/src/docs/MY_PAGE.mdx exists.
	4.	pnpm -C website dev and visit /docs/MY_PAGE.

Rename a page
	1.	Duplicate old → new file, keep old around temporarily.
	2.	Update SIDEBAR.yaml slug/title to the new slug.
	3.	Add a redirect from old to new (see §7).
	4.	Remove the old file once external links have migrated.

Move sections
	•	Reorder in SIDEBAR.yaml; URLs do not change as long as slugs stay the same.

⸻

9) Troubleshooting
	•	404 at /docs/FOO
	•	Ensure SIDEBAR.yaml entry exists or a redirect rule is present.
	•	If embedding, check that sync copied FOO.mdx into website/src/docs/.
	•	Broken external link in CI
	•	Update the target or whitelist ephemeral domains in the link checker, if justified.
	•	Anchor links not working
	•	Ensure headings exist and are unique; avoid duplicate H2/H3 with identical text.
	•	Sidebar shows but content redirects
	•	That’s expected when no local MDX is embedded; it falls back to the canonical URL.

⸻

10) Reproducibility notes
	•	We pin site tooling versions (see website/package.json), and the sync script is deterministic.
	•	Hashes of important doc bundles can be recorded if needed (see docs/REPRODUCIBILITY.md).

⸻

11) What the website does not do
	•	It does not read private tokens or secrets to fetch docs.
	•	It does not build from external repos at runtime; all sync happens at build or dev time.

⸻

12) Quick checklist (PR reviewer)
	•	New/changed doc follows style guide.
	•	SIDEBAR.yaml updated, slugs stable.
	•	Local dev renders or redirects correctly.
	•	Link checker passes.
	•	No broken anchors (spot-check H2/H3).

That’s it. If the sync script is too permissive or strict for your flow, adjust the allowlist in website/scripts/sync_docs_from_repo.mjs.
